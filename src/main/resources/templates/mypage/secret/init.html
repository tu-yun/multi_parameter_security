<!DOCTYPE html>
<html lang="ko" xml:lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:insert="~{fragments/head}"></th:block>

  <script type="text/javascript">
    //비밀번호 재설정
    async function fn_modifyPassword(){
      const newPw = document.querySelector("input[name='newPw']");
      const checkPw = document.querySelector("input[name='checkPw']");

      if(!newPw.value){
        await fn_errorPopup("비밀번호 변경 실패", "새로운 비밀번호를 입력해 주세요.");
        newPw.focus();
        return false;
      }

      if(!checkPw.value){
        await fn_errorPopup("비밀번호 변경 실패", "확인용 비밀번호를 입력해 주세요.");
        checkPw.focus();
        return false;
      }

      if(newPw.value.length < 4 || newPw.value.length > 20){
        await fn_errorPopup("비밀번호 변경 실패", "새로운 비밀번호를 4~20자 내외로 입력해 주세요.");
        newPw.focus();
        return false;
      }

      if(checkPw.value.length < 4 || checkPw.value.length > 20){
        await fn_errorPopup("비밀번호 변경 실패", "확인용 비밀번호를 4~20자 내외로 입력해 주세요.");
        checkPw.focus();
        return false;
      }

      if(newPw.value != checkPw.value){
        await fn_errorPopup("비밀번호 변경 실패", "새로운 비밀번호와 확인용 비밀번호가 일치하지 않습니다.");
        checkPw.focus();
        return false;
      }

      const data = {
        newPw : newPw.value
      }

      $.ajax({
        url: fn_pathname("/mypage/secret/init"),
        type: "patch",
        data: data,
        success: async function(data){
          if(data){
            await fn_complatePopup("비밀번호 변경 완료", "변경된 비밀번호로 다시 로그인해주세요!");
            location.href = fn_pathname("/logout");
          }
        },
        error: async function(xhr){
          if(xhr.responseJSON && xhr.responseJSON.message) {
            await fn_errorPopup("비밀번호 변경 실패", xhr.responseJSON.message);
          } else {
            await fn_errorPopup("비밀번호 변경 실패", "관리자에게 문의하세요.");
          }
        }
      });
    }
  </script>
</head>
<body>
<div id="login_wrap" class="change_pw">
  <div id="login_container">
    <div class="sub_tit_area">
      <div>
        <a th:href="|${_1stPathname}/logout|" class="back_btn">
          <span class="blind">뒤로가기</span>
        </a>
        <strong>비밀번호 변경</strong>
      </div>
    </div>
    <h1 class="logo blind">
      <span class="blind">THEKEEPERSKOREA</span>
    </h1>
    <div class="in_tit type02">
      <strong>새로운 <span>비밀번호를</span><br>입력해 주세요.</strong>
      <p>4~20자 내외로 입력해주세요.</p>
    </div>
    <div class="login_box">
      <form id="form1" name="form1">
        <fieldset>
          <legend>로그인</legend>
          <div class="login_form">
            <div class="input">
              <label for="newPw" class="blind">새로운 비밀번호</label>
              <input type="password" name="newPw" id="newPw" class="rule_noSpace" placeholder="새로운 비밀번호 입력">
              <a href="javascript:void(0);" class="btn_del"><span class="blind">삭제</span></a>
            </div>
            <div class="input">
              <label for="checkPw" class="blind">새로운 비밀번호 확인</label>
              <input type="password" name="checkPw" id="checkPw" class="rule_noSpace" placeholder="새로운 비밀번호를 확인">
              <a href="javascript:void(0);" class="btn_del"><span class="blind">삭제</span></a>
            </div>
          </div>
        </fieldset>
      </form>
    </div>
  </div>
</div>
<div class="fix_btn">
  <button type="button" class="btn fill_primary" onclick="fn_modifyPassword();">
    <span>변경하기</span>
  </button>
</div>

<div id="pwChangeComplete" class="system_alert">
  <div class="dim"></div>
  <div class="popup">
    <div class="pop_cont">
      <i class="ico ico_check"></i>
      <strong>비밀번호 변경 완료</strong>
      <p>
        변경된 비밀번호로 다시 로그인해주세요!
      </p>
    </div>
    <div class="pop_foot ">
      <a href="javascript:void(0);"  class="btn fill_primary" onclick="layerHide('pwChangeComplete')">확인</a>
    </div>
  </div>
</div>

<th:block th:insert="~{fragments/footer}"></th:block>
</body>
</html>

<!DOCTYPE html>
<html lang="ko" xml:lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:insert="~{fragments/head}"></th:block>
    <script type="text/javascript">

        let loadingTime = 15 * 60;

        function fn_updateTimer(){
            loadingTime = loadingTime - 1;
            if(loadingTime < 1){
                location.reload();
            }
            const min = Math.floor(loadingTime / 60);
            const sec = loadingTime % 60;
            document.getElementById("loadingTimer").textContent = String(min).padStart(2, "0") + ":" + String(sec).padStart(2, "0");
        }
        let interval = setInterval(fn_updateTimer, 1000);

        function fn_carSttUpd(obj) {
            clearInterval(interval);
            let carList = $(obj).closest('li');
            $('#usrId').val(carList.find('[name=usrId]').val());
            $('#thisMonthCalcAt').val(carList.find('[name=thisMonthCalcAt]').val());
            $('#carNo').val(carList.find('[name=carNo]').val());
            $('#eeSttCdId').val(carList.find('[name=eeSttCdId]').val());
            $('#carManageId').val(carList.find('[name=carManageId]').val());
            $('#unregCarManageId').val(carList.find('[name=unregCarManageId]').val());
            $('#carEeReqInfoId').val(carList.find('[name=carEeReqInfoId]').val());

            let eeSttCdId = carList.find('[name=eeSttCdId]').val()
            let thisMonthCalcAt = carList.find('[name=thisMonthCalcAt]').val()

            if (eeSttCdId == 101 || eeSttCdId == '') {
                if (thisMonthCalcAt == 'N'){
                    $('#paymentInfo').show();
                } else {
                    $('#requestToLeave').show();
                }

            } else if (eeSttCdId == 103 || eeSttCdId == 104) {
                $('#requestCancel').show();
            }
        }


        function fn_carSttMod() {

            let data = {
                usrId : $('#usrId').val(),
                thisMonthCalcAt : $('#thisMonthCalcAt').val(),
                carNo : $('#carNo').val(),
                carManageId : $('#carManageId').val(),
                unregCarManageId : $('#unregCarManageId').val()
            }
            $.ajax({
                type: 'post',
                url: fn_pathname('/car/modify'),
                contentType: 'application/json;charset=utf-8',
                data: JSON.stringify(data),
                dataType: 'json',
                success: async function (result) {
                    if (result) {
                        await fn_complatePopup("수정 완료", "출차요청이 성공적으로 완료되었습니다.");
                        location.reload();
                    } else {
                        alert('실패되었습니다.\n' +
                            '관리자에게 문의하세요.');
                    }
                },
                error: function (error) {
                    alert('error::' + error.statusText);
                }
            });
        }

         function fn_carSttCancelMod() {

             let data = {
                 usrId : $('#usrId').val(),
                 thisMonthCalcAt : $('#thisMonthCalcAt').val(),
                 carNo : $('#carNo').val(),
                 carManageId : $('#carManageId').val(),
                 unregCarManageId : $('#unregCarManageId').val(),
                 eeSttCdId : $('#eeSttCdId').val(),
                 carEeReqInfoId : $('#carEeReqInfoId').val()
            }

            $.ajax({
                type: 'post',
                url: fn_pathname('/car/cancelMod'),
                contentType: 'application/json;charset=utf-8',
                data: JSON.stringify(data),
                dataType: 'json',
                success: async function (result) {
                    if (result) {
                        await fn_complatePopup("수정 완료", "출차 취소 요청이 성공적으로 완료되었습니다.");
                        location.reload();
                    } else {
                        alert('실패되었습니다.\n' +
                            '관리자에게 문의하세요.');
                    }
                },
                error: function (error) {
                    alert('error::' + error.statusText);
                }
            });
        }

        function fn_paymentInfoChk(){
            $('#paymentInfo').hide();
            $('#requestToLeave').show();
        }
        function fn_requestToLeaveChk(){
            fn_resetCarInfo();
            $('#requestToLeave').hide();
        }
        function fn_requestCancelChk(){
            fn_resetCarInfo();
            $('#requestCancel').hide();
        }
        function fn_resetCarInfo(){
            $('#usrId').val('');
            $('#thisMonthCalcAt').val('');
            $('#carNo').val('');
            $('#eeSttCdId').val('');
            $('#carManageId').val('');
            $('#unregCarManageId').val('');
            $('#carEeReqInfoId').val('');
        };
    </script>
<body>
<div id="wrap">
    <div id="container" class="main">
        <input type="hidden" id="usrId"/>
        <input type="hidden" id="thisMonthCalcAt"/>
        <input type="hidden" id="carNo"/>
        <input type="hidden" id="eeSttCdId"/>
        <input type="hidden" id="carManageId"/>
        <input type="hidden" id="unregCarManageId"/>
        <input type="hidden" id="carEeReqInfoId"/>
        <div class="main_top_area">
            <div class="tit">
                <strong>나의 차량 <span th:text="${userCarCnt}">0</span></strong>
            </div>
            <div class="reset_area">
                <span id="loadingTimer">15:00</span>
                <button type="button" onclick="location.reload();">
                    <span class="blind">초기화</span>
                </button>
            </div>
        </div>
        <div class="car_list_area">
            <div class="sec">
                <div class="contents">
                    <ul class="car_list02 min_h scroll_y">
                        <li th:each="carList : ${getUserCarlist}" th:classappend="${carList.eeSttCdId == 105 || carList.eeSttCdId == 106 || carList.eeSttCdId == 107 ? 'cancel' : ''}">
                            <input type="hidden" name="usrId" th:value="${carList.usrId}"/>
                            <input type="hidden" name="thisMonthCalcAt" th:value="${carList.thisMonthCalcAt}"/>
                            <input type="hidden" name="carNo" th:value="${carList.carNo}"/>
                            <input type="hidden" name="eeSttCdId" th:value="${carList.eeSttCdId}"/>
                            <input type="hidden" name="carManageId" th:value="${carList.carManageId}"/>
                            <input type="hidden" name="unregCarManageId" th:value="${carList.unregCarManageId}"/>
                            <input type="hidden" name="carEeReqInfoId" th:value="${carList.carEeReqInfoId}"/>
                            <div class="box">
                                <div class="box_1">
                                    <div>
                                        <div class="chip fill_yellow40" th:if="${carList.carDvTy == '502' or carList.carDvTy == '503'}">
                                            <span>방문차량</span>
                                        </div>
                                        <th:block th:switch="${carList.eeSttCdId}">
                                            <p th:case="101" class="chip fill_green40">
                                                <span>입차 중</span>
                                            </p>
                                            <p th:case="102" class="chip fill_black10">
                                                <span>출차 중</span>
                                            </p>
                                            <p th:case="103" class="chip fill_error40">
                                                <span th:text="|대기 ${carList.waitSeq}번|">대기 7번</span>
                                            </p>
                                            <p th:case="104" class="chip fill_yellow40">
                                                <span>차량대기중</span>
                                            </p>
                                            <p th:case="105" class="chip fill_error40">
                                                <span>출차 취소 중</span>
                                            </p>
                                            <p th:case="106" class="chip fill_error40">
                                                <span>출차 취소 중</span>
                                            </p>
                                            <p th:case="107" class="chip fill_error40">
                                                <span>출차 취소 중</span>
                                            </p>
                                            <p th:case="108" class="chip fill_primary10">
                                                <span>차량 재입고중</span>
                                            </p>
                                            <p th:case=null style="font-weight: bolder; color: #00b488; display: inline-block;">
                                                <span>상태미등록</span>
                                            </p>
                                        </th:block>
                                    </div>
                                    <div class="df">
                                        <strong th:text="${carList.carNo}" th:value="${carList.carNo}">163마 1234</strong>
                                        <th:block th:switch="${carList.thisMonthCalcAt}">
                                            <!--<p th:case="Y" class="chip fill_success"><span>결제</span></p>-->
                                            <p th:case="N" class="ico_txt_error"><span>결제필요</span></p>
                                        </th:block>
                                    </div>
                                </div>
                                <div class="box_2">
                                    <div class="date01">
                                        차량 등록일 : <span th:text="${carList.regDtmIns}"></span>
                                    </div>
                                    <button type="button" style="margin-left: 50px;" onclick="fn_carSttUpd(this)">
                                    <th:block th:switch="${carList.eeSttCdId}">
                                        <span th:case="101" class="btn fill_primary" >출차요청</span>
                                        <span th:case="102" class="btn fill_primary disabled">출차요청</span>
                                        <span th:case="103" class="btn fill_error" >출차 취소 요청</span>
                                        <span th:case="104" class="btn fill_error" >출차 취소 요청</span>
                                        <span th:case="105" class="btn fill_primary disabled">출차요청</span>
                                        <span th:case="106" class="btn fill_primary disabled">출차요청</span>
                                        <span th:case="107" class="btn fill_primary disabled">출차요청</span>
                                        <span th:case="108" class="btn fill_primary disabled">출차요청</span>
                                        <span th:case=null class="btn fill_primary" >출차요청</span>
                                    </th:block>
                                    </button>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="alram_box type02">
            <p class="tit">알립니다.</p>
            <ul>
                <!--  <li>대기 순번은 최소 3번까지 표시됩니다.</li>-->
                <li>표시된 대기 순위는 주차장 상황에 따라 오차가 발생할 수 있습니다.</li>
            </ul>
        </div>
    </div>

</div>


<div id="paymentInfo" class="system_alert">
    <div class="dim"></div>
    <div class="popup">
        <div class="pop_cont">
            <i class="ico ico_alert"></i>
            <strong>결제 필요 안내</strong>
            <div class="alert_txt">매월 25일~말일 결제일 입니다.</div>
            <p>
                고객님 세대의 결제가 정상적으로<br>
                완료되지 않았습니다.<br>
                결제 여부를 확인 부탁드립니다!
            </p>
        </div>
        <div class="pop_foot ">
            <button type="button" class="btn fill_primary" onclick="fn_paymentInfoChk()">
                확인했습니다
            </button>
        </div>
    </div>
</div>

<div id="requestToLeave" class="system_alert">
    <div class="dim"></div>
    <div class="popup">
        <div class="pop_cont">
            <i class="ico ico_check "></i>
            <strong>출차를 요청 하시겠습니까?</strong>
            <div id="lvvhclChk" class="alert_txt no_ico" th:text="|대기 ${leavingCarCnt}번 입니다.|">대기 7번</div>
        </div>
        <div class="pop_foot type01">
            <button type="button" id="trDel" class="btn fill_primary btn_file_del" onclick="fn_carSttMod()">요청하기</button>
            <a href="javascirpt:void(0);" id="lvvhclPass" class="pop_cancel" onclick="fn_requestToLeaveChk()">다음에할게요</a>
        </div>
    </div>
</div>

<div id="requestCancel" class="system_alert">
    <div class="dim"></div>
    <div class="popup">
        <div class="pop_cont">
            <i class="ico ico_check "></i>
            <strong>출차 취소를 요청 하시겠습니까?</strong>
        </div>
        <div class="pop_foot type01">
            <button type="button" id="trDelCancel" class="btn fill_primary btn_file_del" onclick="fn_carSttCancelMod()">요청하기</button>
            <a href="javascirpt:void(0);" id="lvvhclCancel" class="pop_cancel" onclick="fn_requestCancelChk()">다음에할게요</a>
        </div>
    </div>
</div>



<th:block th:insert="~{fragments/header}"></th:block>
<th:block th:insert="~{fragments/footer}"></th:block>
</body>
</html>
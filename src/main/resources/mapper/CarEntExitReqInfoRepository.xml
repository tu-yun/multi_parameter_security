<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.thekeeperskorea.mb_usr.repository.CarEntExitReqInfoRepository">

   <insert id="setUnregInset" parameterType="CarEntExitReqInfoDto" useGeneratedKeys="true" keyProperty="carEeReqInfoId">
       INSERT INTO TBL_CAR_ENT_EXIT_REQ_INFO
       (
       unreg_car_manage_id
       ,ee_stt_cd_id
       ,ee_req_stt_cd_id
       ,reg_ps_id
       ,reg_dtm
       ,ee_req_end_at
       )
       VALUES
           (
           #{unregCarManageId}
           ,#{eeSttCdId}
           ,#{eeReqSttCdId}
           ,#{regPsId}
           ,#{regDtm}
           ,#{eeReqEndAt}
           )
  </insert>

    <insert id="setUsrInset"  parameterType="CarEntExitReqInfoDto" useGeneratedKeys="true" keyProperty="carEeReqInfoId">
        INSERT INTO TBL_CAR_ENT_EXIT_REQ_INFO
        (
        car_manage_id
        ,ee_stt_cd_id
        ,ee_req_stt_cd_id
        ,reg_ps_id
        ,reg_dtm
        ,ee_req_end_at
        )
        VALUES
            (
            #{carManageId}
            ,#{eeSttCdId}
            ,#{eeReqSttCdId}
            ,#{regPsId}
            ,#{regDtm}
            ,#{eeReqEndAt}
            )
    </insert>

    <update id="carSttCancelUpdate"  parameterType="kr.or.thekeeperskorea.mb_usr.model.car.CarEntExitReqInfoDto">
        update TBL_CAR_ENT_EXIT_REQ_INFO
        <set>
            <if test="eeSttCdId != null and eeSttCdId != '' " >
                ee_stt_cd_id = #{eeSttCdId}
            </if>
        </set>
        where car_ee_req_info_id = #{carEeReqInfoId}
    </update>

    <select id="leavingCarCnt" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT
            IFNULL(MAX(waitSeq) + 1 , 1) AS maxWaitSeq
        FROM (
                 SELECT
                     ROW_NUMBER() OVER (ORDER BY MAX(tceeri.reg_dtm) ASC) AS waitSeq
                 FROM TBL_CAR_ENT_EXIT_REQ_INFO tceeri
                          LEFT JOIN TBL_USER_CAR tuc ON tceeri.car_manage_id = tuc.car_manage_id AND tuc.del_at = 'N' AND tuc.use_at = 'Y'
                          LEFT JOIN TBL_USER tu ON tuc.usr_id = tu.usr_id AND tu.del_at = 'N' AND tu.use_at = 'Y' AND tu.secsn_at = 'N'
                          LEFT JOIN TBL_UNREG_CAR tuc2 ON tceeri.unreg_car_manage_id = tuc2.unreg_car_manage_id AND tuc2.del_at = 'N' AND tuc2.use_at = 'Y'
                 WHERE tceeri.ee_req_end_at = 'N'
                   AND tceeri.ee_req_stt_cd_id = 202
                   AND tceeri.ee_stt_cd_id = 103
                   AND (tu.prkplce_id = #{prkplceId} OR tuc2.prkplce_id = #{prkplceId})
                 GROUP BY tceeri.car_manage_id, tceeri.unreg_car_manage_id
             ) AS SubQueryAlias;
    </select>

</mapper>




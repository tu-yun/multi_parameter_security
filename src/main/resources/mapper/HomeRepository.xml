<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.thekeeperskorea.mb_usr.repository.HomeRepository">

    <select id="getUserCarlist" parameterType="java.lang.Long" resultType="UserCarDto">
        SELECT sub.car_manage_id
             ,sub.unreg_car_manage_id
             ,DATE_FORMAT(sub.regDtm, '%Y-%m-%d') AS regDtmIns
             ,sub.car_no
             ,sub.car_dv_ty
             ,sub.ee_stt_cd_id
             ,sub.ee_stt_cd_nm
             ,sub.ee_stt_chg_dtm
             ,sub.ee_stt_chg_dt
             ,sub.usr_id
             ,sub.car_ee_req_info_id
             ,tceeri.waitSeq
             ,calcAt.this_month_calc_at
        FROM (SELECT tuc.car_manage_id
                   ,NULL AS unreg_car_manage_id
                   ,tuc.vhcle_reg_dt as regDtm
                   ,tuc.car_no
                   ,tuc.car_dv_ty
                   ,tuc.ee_stt_cd_id
                   ,tcc.cd_nm AS ee_stt_cd_nm
                   ,tuc.ee_stt_chg_dtm
                   ,DATE_FORMAT(tuc.ee_stt_chg_dtm, '%Y-%m-%d') AS ee_stt_chg_dt
                   ,tuc.usr_id
                   ,tuc.this_month_calc_at
                   ,tuc.car_ee_req_info_id
              FROM TBL_USER_CAR tuc
                       left JOIN TBL_COMMON_CODE tcc ON tuc.ee_stt_cd_id = tcc.cd_id AND tcc.delete_at = 'N'
                       INNER JOIN TBL_USER tu ON tuc.usr_id = tu.usr_id AND tuc.del_at = 'N' AND tuc.use_at = 'Y' AND tu.del_at = 'N' AND tu.use_at = 'Y' AND secsn_at = 'N'
              WHERE tu.prkplce_id = #{prkplceId}
              UNION ALL
              SELECT NULL AS car_manage_id
                   ,tuc.unreg_car_manage_id
                   ,tuc.reg_dtm as regDtm
                   ,tuc.car_no
                   ,tuc.car_dv_ty
                   ,tuc.ee_stt_cd_id
                   ,tcc.cd_nm AS ee_stt_cd_nm
                   ,tuc.ee_stt_chg_dtm
                   ,DATE_FORMAT(tuc.ee_stt_chg_dtm, '%Y-%m-%d') AS ee_stt_chg_dt
                   ,tuc.usr_id
                   ,NULL AS this_month_calc_at
                   ,tuc.car_ee_req_info_id
              FROM TBL_UNREG_CAR tuc
                       left JOIN TBL_COMMON_CODE tcc ON tuc.ee_stt_cd_id = tcc.cd_id AND tcc.delete_at = 'N'
                       LEFT OUTER JOIN TBL_USER tu ON tuc.usr_id = tu.usr_id AND tuc.del_at = 'N' AND tuc.use_at = 'Y' AND tu.del_at = 'N' AND tu.use_at = 'Y' AND secsn_at = 'N'
              WHERE ee_stt_cd_id != 102
                   AND tuc.prkplce_id = #{prkplceId}) sub
                 LEFT JOIN (
                            SELECT
                                car_manage_id,
                                this_month_calc_at
                            FROM TBL_USER_CAR
                        ) calcAt ON calcAt.car_manage_id = sub.car_manage_id
                 LEFT JOIN (SELECT ROW_NUMBER() OVER (ORDER BY MAX(tceeri.reg_dtm) ASC) AS waitSeq
                                  ,tceeri.car_manage_id
                                 ,tceeri.unreg_car_manage_id
                            FROM TBL_CAR_ENT_EXIT_REQ_INFO tceeri
                                     LEFT OUTER JOIN TBL_USER_CAR tuc ON tceeri.car_manage_id = tuc.car_manage_id AND tuc.del_at = 'N' AND tuc.use_at = 'Y'
                                     LEFT OUTER JOIN TBL_USER tu ON tuc.usr_id = tu.usr_id AND tu.del_at = 'N' AND tu.use_at = 'Y' AND tu.secsn_at = 'N'
                                     LEFT OUTER JOIN TBL_UNREG_CAR tuc2 ON tceeri.unreg_car_manage_id = tuc2.unreg_car_manage_id AND tuc2.del_at = 'N' AND tuc2.use_at = 'Y'
                            WHERE tceeri.ee_req_end_at = 'N'
                              AND tceeri.ee_req_stt_cd_id = 202
                              AND tceeri.ee_stt_cd_id = 103
                              AND (tu.prkplce_id = #{prkplceId} OR tuc2.prkplce_id = #{prkplceId})
                            GROUP BY tceeri.car_manage_id, tceeri.unreg_car_manage_id) tceeri ON CASE WHEN sub.car_dv_ty = 501 AND sub.car_manage_id = tceeri.car_manage_id THEN 1
                                                                                                      WHEN sub.car_dv_ty = 502 AND sub.unreg_car_manage_id = tceeri.unreg_car_manage_id THEN 1
                                                                                                      ELSE 0 END = 1
        where sub.usr_id = #{usrId}
    </select>


    <select id="getUserCarCnt" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT
            COUNT(*)
        FROM (SELECT tuc.car_manage_id
                   ,NULL AS unreg_car_manage_id
                   ,tuc.vhcle_reg_dt as regDtm
                   ,tuc.car_no
                   ,tuc.car_dv_ty
                   ,tuc.ee_stt_cd_id
                   ,tcc.cd_nm AS ee_stt_cd_nm
                   ,tuc.ee_stt_chg_dtm
                   ,DATE_FORMAT(tuc.ee_stt_chg_dtm, '%Y-%m-%d') AS ee_stt_chg_dt
                   ,tuc.usr_id
                   ,tuc.this_month_calc_at
                   ,tuc.car_ee_req_info_id
              FROM TBL_USER_CAR tuc
                       left JOIN TBL_COMMON_CODE tcc ON tuc.ee_stt_cd_id = tcc.cd_id AND tcc.delete_at = 'N'
                       INNER JOIN TBL_USER tu ON tuc.usr_id = tu.usr_id AND tuc.del_at = 'N' AND tuc.use_at = 'Y' AND tu.del_at = 'N' AND tu.use_at = 'Y' AND secsn_at = 'N'
              WHERE tu.prkplce_id = #{prkplceId}
              UNION ALL
              SELECT NULL AS car_manage_id
                   ,tuc.unreg_car_manage_id
                   ,tuc.reg_dtm as regDtm
                   ,tuc.car_no
                   ,tuc.car_dv_ty
                   ,tuc.ee_stt_cd_id
                   ,tcc.cd_nm AS ee_stt_cd_nm
                   ,tuc.ee_stt_chg_dtm
                   ,DATE_FORMAT(tuc.ee_stt_chg_dtm, '%Y-%m-%d') AS ee_stt_chg_dt
                   ,tuc.usr_id
                   ,NULL AS this_month_calc_at
                   ,tuc.car_ee_req_info_id
              FROM TBL_UNREG_CAR tuc
                       left JOIN TBL_COMMON_CODE tcc ON tuc.ee_stt_cd_id = tcc.cd_id AND tcc.delete_at = 'N'
                       LEFT OUTER JOIN TBL_USER tu ON tuc.usr_id = tu.usr_id AND tuc.del_at = 'N' AND tuc.use_at = 'Y' AND tu.del_at = 'N' AND tu.use_at = 'Y' AND secsn_at = 'N'
              WHERE ee_stt_cd_id != 102
                   AND tuc.prkplce_id = #{prkplceId}) sub
                 LEFT JOIN (
            SELECT
                car_manage_id,
                this_month_calc_at
            FROM TBL_USER_CAR
        ) calcAt ON calcAt.car_manage_id = sub.car_manage_id
                 LEFT JOIN (SELECT ROW_NUMBER() OVER (ORDER BY MAX(tceeri.reg_dtm) ASC) AS waitSeq
                                  ,tceeri.car_manage_id
                                 ,tceeri.unreg_car_manage_id
                            FROM TBL_CAR_ENT_EXIT_REQ_INFO tceeri
                                     LEFT OUTER JOIN TBL_USER_CAR tuc ON tceeri.car_manage_id = tuc.car_manage_id AND tuc.del_at = 'N' AND tuc.use_at = 'Y'
                                     LEFT OUTER JOIN TBL_USER tu ON tuc.usr_id = tu.usr_id AND tu.del_at = 'N' AND tu.use_at = 'Y' AND tu.secsn_at = 'N'
                                     LEFT OUTER JOIN TBL_UNREG_CAR tuc2 ON tceeri.unreg_car_manage_id = tuc2.unreg_car_manage_id AND tuc2.del_at = 'N' AND tuc2.use_at = 'Y'
                            WHERE tceeri.ee_req_end_at = 'N'
                              AND tceeri.ee_req_stt_cd_id = 202
                              AND tceeri.ee_stt_cd_id = 103
                              AND (tu.prkplce_id = #{prkplceId} OR tuc2.prkplce_id = #{prkplceId})
                            GROUP BY tceeri.car_manage_id, tceeri.unreg_car_manage_id) tceeri ON CASE WHEN sub.car_dv_ty = 501 AND sub.car_manage_id = tceeri.car_manage_id THEN 1
                                                                                                      WHEN sub.car_dv_ty = 502 AND sub.unreg_car_manage_id = tceeri.unreg_car_manage_id THEN 1
                                                                                                      ELSE 0 END = 1
        where sub.usr_id = #{usrId}
    </select>

</mapper>